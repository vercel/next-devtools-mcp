# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an MCP (Model Context Protocol) server that provides Next.js development tools for AI coding assistants. The server exposes tools, prompts, and resources to help with Next.js upgrades, Cache Components setup, documentation search, browser testing, and runtime diagnostics.

## Build and Development Commands

```bash
# Install dependencies
pnpm install

# Build the project (required before running tests or publishing)
pnpm build

# Watch mode for development
pnpm dev

# Run tests (IMPORTANT: must run pnpm build first)
pnpm build && pnpm test

# Type check
pnpm typecheck

# Clean build artifacts
pnpm clean
```

## Testing

The test suite uses vitest with Claude Agent SDK for E2E testing:

```bash
# Run all tests
pnpm build && pnpm test

# Note: Tests require ANTHROPIC_API_KEY environment variable
# Get your key from: https://console.anthropic.com/
```

Test files are located in `test/e2e/` and use test fixtures from `test/fixtures/`.

## Architecture

### MCP Server Structure

The main server is generated by `xmcp` (configured in `xmcp.config.ts`) and uses stdio transport. The server automatically registers:
- **Tools** (`src/tools/`): Callable functions for automation
- **Prompts** (`src/prompts/`): Pre-configured prompts for common tasks
- **Resources** (`src/resources/`): Knowledge base articles and documentation

### Key Components

**MCP Tools** (`src/tools/`):
- Tools are automatically discovered and registered by xmcp from `src/tools/`
- `nextjs_docs`: Search Next.js documentation and knowledge base
- `browser_eval`: Playwright browser automation (via `playwright-mcp` server)
- `nextjs_runtime`: Connect to Next.js dev server MCP endpoint for runtime diagnostics
- `upgrade_nextjs_16`: Automated Next.js 16 upgrade guidance
- `enable_cache_components`: Complete Cache Components setup with error detection

**MCP Client Library** (`src/_internal/mcp-client.ts`):
- Connects to external MCP servers via stdio transport
- Used by `browser_eval` to communicate with `playwright-mcp`
- Used by `nextjs_runtime` to communicate with Next.js dev server MCP endpoint

**Runtime Managers** (`src/_internal/`):
- `browser-eval-manager.ts`: Manages Playwright MCP server lifecycle
- `nextjs-runtime-manager.ts`: Discovers and connects to Next.js dev servers with MCP enabled

**Resources Architecture**:
- Knowledge base split into focused sections (12 sections for Next.js 16)
- Resources are loaded on-demand to avoid overwhelming context
- Markdown files in `src/resources/` are copied to `dist/resources/` during build via `scripts/copy-resources.js`

### TypeScript Configuration

- Target: ES2022, CommonJS modules
- Strict mode enabled
- Output directory: `dist/`
- Declaration files generated

## Build Process

1. Server generation: `xmcp build` generates the MCP server from `xmcp.config.ts` configuration
2. Resource copying: `scripts/copy-resources.js` copies markdown files from `src/resources/` and `src/prompts/` to `dist/resources/`

The `dist/stdio.js` file is the entry point for the MCP server and includes a shebang for CLI execution.

## MCP Protocol Integration

This server can:
1. Act as a standalone MCP server (stdio transport)
2. Connect to other MCP servers as a client (e.g., playwright-mcp, Next.js runtime MCP)

**Key MCP Patterns**:
- Tools use Zod schemas for input validation
- Tool handlers receive validated arguments via `tool.execute()`
- Resources use URI-based addressing (e.g., `nextjs16://knowledge/overview`)
- Prompts return structured messages with markdown content

## External MCP Server Dependencies

**Playwright MCP** (`browser_eval` tool):
- Automatically installed globally via npm when needed
- Package: `@playwright/mcp`
- Command: `npx @playwright/mcp@latest` (with optional `--browser` and `--headless` flags)
- Used for browser automation and testing

**Next.js Runtime MCP** (`nextjs_runtime` tool):
- Built into Next.js 16+ (enabled by default)
- Endpoint: `http://localhost:<port>/_next/mcp`
- Provides runtime diagnostics, errors, routes, and build status
- Server discovery via common ports (3000, 3001, etc.)

## Common Development Patterns

**Adding a new MCP tool**:
1. Create tool file in `src/tools/` with Zod schema and `tool()` function
2. xmcp automatically discovers and registers tools from `src/tools/`
3. Build and test

**Adding a new MCP resource**:
1. Create markdown file(s) in `src/resources/`
2. Create resource handler TypeScript file in `src/resources/` with URI scheme
3. xmcp automatically discovers and registers resources from `src/resources/`
4. The `scripts/copy-resources.js` script automatically copies `.md` files to `dist/resources/`

**Working with external MCP servers**:
- Use `src/_internal/mcp-client.ts` for stdio-based communication
- Create manager module in `src/_internal/` for lifecycle management
- Handle server installation, connection, and cleanup

## Package Publishing

- Package name: `next-devtools-mcp`
- Binary: `next-devtools-mcp` points to `dist/stdio.js`
- prepublishOnly hook: cleans and rebuilds before publishing
- Use `pnpm@9.15.9` as package manager
